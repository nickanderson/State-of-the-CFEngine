#+Title: State of the CFEngine
#+SUBTITLE: Or Since last time at Config Management Camp
#+Author: Nick Anderson
#+Email: nick.anderson@northern.tech
#+REVEAL_ROOT: file:///home/nickanderson/src/reveal.js/
#+OPTIONS: reveal_center:t reveal_progress:t reveal_history:nil reveal_control:t
#+OPTIONS: reveal_rolling_links:t reveal_keyboard:t reveal_overview:t num:nil
#+OPTIONS: reveal_width:1200 reveal_height:800
#+OPTIONS: reveal_single_file:t
# The TOC is a bit much for a slide show IMHO
#+OPTIONS: toc:nil tags:nil timestamp:nil
#+REVEAL_MARGIN: 0.1
#+REVEAL_MIN_SCALE: 0.5
#+REVEAL_MAX_SCALE: 2.5
# Available Transitions: default|cube|page|concave|zoom|linear|fade|none.
#+REVEAL_TRANS: fade
# Themes: Black (default) - White - League - Sky - Beige - Simple - Serif - Blood - Night - Moon - Solarized 
#+REVEAL_THEME: white 
# ?? Guess this flattens up to x levels deep
#+REVEAL_HLEVEL: 1
#+REVEAL_HEAD_PREAMBLE: <meta name=description" content=Or Since last time at config management camp ...">
#+REVEAL_POSTAMBLE: <p> Created by Nick Anderson. </p>
#+REVEAL_PLUGINS: (markdown notes)
#+REVEAL_TITLE_SLIDE_BACKGROUND: ./orange-blue-tilt-right.png
#+OPTIONS: H:1

* 
:PROPERTIES:
:REVEAL_BACKGROUND: ./2018-01-14_Selection_005.png
:END:

* Releases
:DRAWER:
#+BEGIN_SRC shell :dir ~/CFEngine/masterfiles :exports results :wrap text
  echo "$(git for-each-ref --sort=taggerdate --format '%(tag)_,,,_%(taggerdate:raw)' refs/tags \
    | awk 'BEGIN { FS = "_,,,_" };
                 { t=strftime("%Y-%m-%d",$2);
                 printf "%s %s\n", t, $1 }' \
    | egrep -v "build|PTV|\.0b" \
    | egrep "2017|2018" \
    | wc -l) releases"
#+END_SRC
#+RESULTS:
:END:
7 releases since 2017-01-01

:DRAWER:

#+BEGIN_COMMENT
  Post process the generated table to add org header markup https://emacs.stackexchange.com/a/19521
#+END_COMMENT

#+name: addhdr
#+begin_src emacs-lisp :var tbl="" :exports none
(cons (car tbl) (cons 'hline (cdr tbl)))
#+end_src


#+Name: Release Dates
#+BEGIN_SRC shell :dir ~/CFEngine/core :exports results :results table :post addhdr(*this*)
  git for-each-ref --sort=taggerdate --format '%(tag)_,,,_%(taggerdate:raw)' refs/tags \
    | awk 'BEGIN { FS = "_,,,_"; print "Version Date \n| ------- | ---------- |" };
                 { t=strftime("%Y-%m-%d",$2);
                 printf "%s %s\n", $1, t  }' \
    | egrep -v "build|PTV|\.0b" \
    | egrep "2017|2018|Date"
#+END_SRC
:END:
#+RESULTS: Release Dates
| Version |       Date |
|---------+------------|
|   3.7.5 | 2017-03-30 |
|  3.10.1 | 2017-03-30 |
|  3.10.2 | 2017-08-11 |
|  3.11.0 | 2017-08-11 |
|   3.7.6 | 2017-09-12 |
|  3.10.3 | 2018-02-02 |
|   3.7.7 | 2018-02-02 |

* Contributions
#+Name: NumCommits
#+BEGIN_SRC shell :dir /tmp/ :exports none :results table :var REPOSITORY="https://github.com/cfengine/core"
  #REPOSITORY=https://github.com/cfengine/core
  TMP=$(mktemp --directory --quiet) 
  mkdir -p $TMP
  cd $TMP
  git clone $REPOSITORY
  REPO="$(basename $REPOSITORY)"
  cd "$TMP/$REPO"
  LASTYEAR=$(date -d "-1 year" '+%Y')
  LASTNEWYEAR="$LASTYEAR-01-01"
  NUMCOMMITS=$(git --no-pager log --since "$LASTNEWYEAR" --oneline --no-merges | wc -l)
  rm -rf "$TMP"
  echo "$NUMCOMMITS"
#+END_SRC

#+Name: NumCoreCommits
#+CALL: NumCommits(REPOSITORY="https://github.com/cfengine/core") :exports none

#+RESULTS: NumCoreCommits
| 265 |

#+Name: NumMPFCommits
#+CALL: NumCommits(REPOSITORY="https://github.com/cfengine/masterfiles") :exports none

#+RESULTS: NumMPFCommits
| 163 |

#+Name: NumDocCommits
#+CALL: NumCommits(REPOSITORY="https://github.com/cfengine/Documentation") :exports none

#+RESULTS: NumDocCommits
| 207 |

#+Name: NumContributors
#+BEGIN_SRC shell :dir /tmp/ :exports none :results table :var REPOSITORY="https://github.com/cfengine/core"
  TMP=$(mktemp --directory --quiet) 
  mkdir -p $TMP
  cd $TMP
  git clone $REPOSITORY
  REPO="$(basename $REPOSITORY)"
  cd "$TMP/$REPO"
  LASTYEAR=$(date -d "-1 year" '+%Y')
  LASTNEWYEAR="$LASTYEAR-01-01"
  NUMAUTHORS=$(git-stats --since "$LASTNEWYEAR" --authors --raw | jq '.authors | length')
  rm -rf "$TMP"
  echo "$NUMAUTHORS"
#+END_SRC

#+Name: NumCoreContributors
#+CALL: NumContributors(REPOSITORY="https://github.com/cfengine/core") :exports none

#+RESULTS: NumCoreContributors
| 24 |

#+Name: NumMPFContributors
#+CALL: NumContributors(REPOSITORY="https://github.com/cfengine/masterfiles") :exports none

#+RESULTS: NumMPFContributors
| 14 |

#+Name: NumDocContributors
#+CALL: NumContributors(REPOSITORY="https://github.com/cfengine/documentation") :exports none

#+RESULTS: NumDocContributors
| 17 |

#+Name: NewContributors
#+BEGIN_SRC shell :dir /tmp :exports none :results table :var REPOSITORY="https://github.com/cfengine/core"
  TMP=$(mktemp --directory --quiet) 
  mkdir -p $TMP
  cd $TMP
  git clone $REPOSITORY
  REPO="$(basename $REPOSITORY)"
  cd "$TMP/$REPO"
  LASTYEAR=$(date -d "-1 year" '+%Y')
  THISYEAR=$(date '+%Y')
  LASTNEWYEAR="$LASTYEAR-01-01"
  git --no-pager log --format="%aN" | sort -u  > /tmp/authors.txt
  CONTRIBUTORS="/$TMP/$REPO-first-contributions.dat"
  rm -f $CONTRIBUTORS
  while read Author; do
    FirstCommit=$(git --no-pager log --author "$Author" --format="%cI" | sort | head -n 1)
    echo "$FirstCommit,$Author" >> $CONTRIBUTORS
  done < /tmp/authors.txt 
  egrep -c "^($LASTYEAR|$THISYEAR).*" $CONTRIBUTORS 
  rm -rf $TMP
#+END_SRC

#+Name: NewCoreContributors
#+CALL: NewContributors(REPOSITORY="https://github.com/cfengine/core") :exports none

#+RESULTS: NewCoreContributors
| 9 |

#+Name: NewMPFContributors
#+CALL: NewContributors(REPOSITORY="https://github.com/cfengine/masterfiles") :exports none

#+RESULTS: NewMPFContributors
| 4 |

#+Name: NewDocContributors
#+CALL: NewContributors(REPOSITORY="https://github.com/cfengine/documentation") :exports none

#+RESULTS: NewDocContributors
| 6 |

#+Name: Contributions since 2017-01-01 
|                  | Core | MPF | Docs |
| Commits          |  256 | 163 |  207 |
| Contributors     |   24 |  14 |   17 |
| New Contributors |    9 |   4 |    6 |
#+TBLFM: @2$2=remote(NumCoreCommits,@>$0);::@2$3=remote(NumMPFCommits,@>$0);::@2$4=remote(NumDocCommits,@>$0);::@3$2=remote(NumCoreContributors,@>$0);::@3$3=remote(NumMPFContributors,@>$0);::@3$4=remote(NumDocContributors,@>$0);::@4$2=remote(NewCoreContributors,@>$0);::@4$3=remote(NewMPFContributors,@>$0);::@4$4=remote(NewDocContributors,@>$0);

* Core Functionality
** =with= attribute
:PROPERTIES:
:BEAMER_env: frame
:END:

#+Name: With attribute usage example
#+Caption: With attribute usage example policy
#+BEGIN_SRC cfengine3 :exports both
bundle agent main
{
  vars:
      "todo" slist => { "a 1", "b 2", "c 3" };
      # Here, `with` is the canonified version of $(todo), letting us avoid an

      # intermediate canonification array.
      "$(with)" string => "$(todo)", with => canonify($(todo));

      "complex" data => '
{
  "x": 200,
  "y": [ 1, 2, null, true, false ]
}
';

  reports:
      "For iterable '$(todo)' we created variable '$(with)' and its value is '$(todo)'"
        with => canonify($(todo));

      "We can print a data container compactly without creating a temporary variable: $(with)"
        with => format("%S", complex);

      "We can print a data container fully without creating a temporary variable: $(with)"
        with => storejson(complex);
}
#+END_SRC

** =with= attribute
:PROPERTIES:
:BEAMER_env: frame
:END:

#+Caption: With attribute usage example policy output
#+RESULTS: With attribute usage example
#+begin_example
R: For iterable 'a 1' we created variable 'a_1' and its value is 'a 1'
R: For iterable 'b 2' we created variable 'b_2' and its value is 'b 2'
R: For iterable 'c 3' we created variable 'c_3' and its value is 'c 3'
R: We can print a data container compactly without creating a temporary variable: {"x":200,"y":[1,2,null,true,false]}
R: We can print a data container fully without creating a temporary variable: {
  "x": 200,
  "y": [
    1,
    2,
    null,
    true,
    false
  ]
}
#+end_example

** =inline_mustache=
:PROPERTIES:
:BEAMER_env: frame
:END:

#+BEGIN_NOTES
  You are no longer required to use an external file template. Now you can
  provide the template directly within the policy.
#+END_NOTES

#+Caption: Example =template_method= =inline_mustache=
#+BEGIN_SRC cfengine3
  bundle agent main
  {
    vars:
      "d" data => '{ "hello": "world", "feature": [ "render", "inline", "mustache" ] }';

    files:

      "/tmp/example.txt"
        create => "true",
        template_method => "inline_mustache",
        edit_template_string => "{{%-top-}}",
        template_data => @(d);

  }
#+END_SRC

** =inline_mustache=
:PROPERTIES:
:BEAMER_env: frame
:END:

Results in =/tmp/example.txt= having this content.

#+Caption: Example =template_method= =inline_mustache=
#+BEGIN_SRC text
  {
    "feature": [
      "render",
      "inline",
      "mustache"
    ],
    "hello": "world"
  }
#+END_SRC
** Multiple augments
:PROPERTIES:
:BEAMER_env: frame
:END:

*NOTE:* Current implementation discussion in progress in [[jira:CFE-2741][CFE-2741]]. Please
consider participating.

#+Caption: Example =/tmp/def.json=
#+BEGIN_SRC json
{
  "vars":{
    "my_var": "defined in def.json",
    "my_other_var": "Defined ONLY in def.json"
  },
  "augments": [
    "/tmp/$(sys.flavor).json"
  ]
}
#+END_SRC

** Multiple augments
:PROPERTIES:
:BEAMER_env: frame
:END:

#+Caption: Example =/tmp/centos_6.json=
#+BEGIN_SRC json
{
  "vars": {
    "my_var": "Overridden in centos_6.json",
    "centos_6_var": "Defined ONLY in centos_6.json"
  }
}
#+END_SRC

** Multiple augments
:PROPERTIES:
:BEAMER_env: frame
:END:

#+Caption: Execution output on CentOS 6
#+BEGIN_EXAMPLE
[root@hub tmp]# cf-agent -KIf ./example.cf 
R: def.my_var == Overridden in centos_6.json
R: def.my_other_var == Defined ONLY in def.json
R: def.centos_6_var == Defined ONLY in centos_6.json
#+END_EXAMPLE

** =missing_ok=
:PROPERTIES:
:BEAMER_env: frame
:END:
* MPF Functionality
** Augments - Append the =bundlesequnece= of =promises.cf= and =update.cf=
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_common_bundlesequence_end=
- =control_common_update_bundlesequence_end=

#+BEGIN_SRC json
{
  "vars":{
    "control_common_bundlesequence_end": [ "mybundle1", "mybundle2" ],
    "control_common_update_bundlesequence_end": [ "my_updatebundle1", "mybundle2" ]
  }
}
#+END_SRC

- Order of bundle actuation not guaranteed.
- Agent errors if named bundle is missing.

** Augments - Log file retention and rotation limits
:PROPERTIES:
:BEAMER_env: frame
:END:

- =mpf_log_files_max_size= :: Max file size before rotation
- =mpf_log_file_retention= :: Number of file rotations to keep
- =mpf_log_dir_retention= :: Number of file rotations to keep in =outputs=,
     =reports=, and the Enterprise application log directory.

#+BEGIN_SRC json
{
  "vars": {
    "mpf_log_file_retention": "5",
    "mpf_log_file_max_size": "10M",
    "mpf_log_dir_retention": "7"
  }
}
#+END_SRC

** Augments - Execution schedule
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_executor_schedule= :: Classes that trigger execution of =cf-agent=.
 
#+BEGIN_SRC json
{
  "vars": {
    "control_executor_schedule": [ "Min00", "Min30" ]
  }
}
#+END_SRC 

** Augments - =splaytime=
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_executor_splaytime= :: Maximum number of minutes =exec_commad= should
     wait before executing.

#+BEGIN_SRC json
{
  "vars": {
    "control_executor_splaytime": "3"
  }
}
#+END_SRC

** Augments - =allowlegacyconnects=
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_server_allowlegacyconnects= :: List of subnets allowed to connect
     using legacy protocol (versions prior to 3.7.0).

#+BEGIN_SRC json
{
  "vars": {
    "control_server_allowlegacyconnects": [ "0.0.0.0/0" ]
  }
}
#+END_SRC

** Augments - =maxconnections=
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_serverd_maxconnections= :: Maximum number of connections allowed by
     =cf-serverd=.

#+BEGIN_SRC json
{
  "vars":{
      "control_serverd_maxconnections": "1000"
  }
}
#+END_SRC

** Augments - Client initiated reporting (Enterprise)
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_hub_exclude_hosts= :: List of subnets to exclude from hub initiated
     report collection.
- =client_initiated_reporting_enabled= :: List of classes that if defined should
     initiate reporting to an enterprise hub.
- =control_server_call_collect_interval= :: Number of minutes between client
     initiated reporting.

#+BEGIN_SRC json
  {
      "vars": {
          "control_server_call_collect_interval": "1",
          "control_hub_exclude_hosts": [ "0.0.0.0/0" ]
      },

      "classes" {
          "client_initiated_reporting_enabled": [ "any" ]
      }
  }
#+END_SRC

** Augments - =files_single_copy=
:PROPERTIES:
:BEAMER_env: frame
:END:

- =control_agent_files_single_copy= :: List of regular expressions matching
     files that should not be copied more than once.

#+BEGIN_SRC json
{
  "vars":{
    "control_agent_files_single_copy": [ ".*" ]
  }

}
#+END_SRC

** Augments - =default_repository=
:PROPERTIES:
:BEAMER_env: frame
:END:

- =mpf_control_agent_default_repository= :: List of classes class will cause
     these backups to be placed in =$(sys.workdir)/backups=.

- =control_agent_default_backup= :: Directory where backups should be placed
     (defaults to =$(sys.workdir/backups=).

#+BEGIN_SRC json

{
  "classes": {
    "mpf_control_agent_default_repository": [ "any" ]
  },

  "vars": {
    "control_agent_default_repository": "/var/cfengine/edit_backups"
  }
}
#+END_SRC

** =templates= shortcut 
:PROPERTIES:
:BEAMER_env: frame
:END:

- =dir_templates= :: Path to common template directory. Shortcut provided by
     =cf-serverd= as =templates/=.
 
  #+BEGIN_SRC json
  {
      "vars": {
          "dir_templates": "/var/cfengine/mytemplates"
          }
  }
  #+END_SRC 

#+BEGIN_SRC cfengine3
  bundle agent example
  {
    files:

      "$(def.dir_templates)/mytemplate.mustache" -> { "myservice" }

        copy_from => remote_dcp( "templates/mytemplate.mustache",
                                 $(sys.policy_server) ),
      
        comment => "mytemplate is necessary in order to render
                    myservice configuration file.";
  }
#+END_SRC

** Automatically restart components on related data change
:PROPERTIES:
:BEAMER_env: frame
:END:

#+BEGIN_NOTES
  While the agent itsef will reload its config upon notice of policy change this
  bundle specifically handles changes to variables used in the MPF which may come
  from external data sources which are unknown to the components themselves.
#+END_NOTES

- =mpf_augments_control_enabled= :: List of classes that automatic component
     restart on related data change should be enabled for.

#+BEGIN_SRC json
{
  "classes":{
      "mpf_augments_control_enabled": [ "any" ]
  }
}
#+END_SRC

** Host info report now now renders inventory variables
:PROPERTIES:
:BEAMER_env: frame
:END:

#+BEGIN_SRC shell
  cf-agent -KIb host_info_report
#+END_SRC

#+Caption: Sample from inventory section of host info report
#+BEGIN_SRC text
### Inventory

#### Variables tagged for inventory

{
  "default:cfe_autorun_inventory_disk.free": "5.00",
  "default:cfe_autorun_inventory_listening_ports.ports": [
    "22",
    "25",
    "53",
  ],
  "default:cfe_autorun_inventory_memory.total": "32050.27",
  "default:sys.arch": "x86_64",
  "default:sys.cf_version": "3.11.0",
  "default:sys.class": "linux",
  "default:sys.cpus": "4",
  "default:sys.flavor": "ubuntu_17",
  "default:sys.hardware_addresses": [
    "5c:e0:c5:9f:f3:8f",
    "52:54:00:6b:62:06",
    "02:42:79:79:f6:02",
    "0a:00:27:00:00:00"
  ],
  "default:sys.inet": {
    "default_gateway": "192.168.42.1",
#+END_SRC 

* Enterprise Functionality
** UI responsiveness                                                :ATTACH:
:PROPERTIES:
:Attachments: alert-status-speed-comparison.webm
:ID:       75971753-cddb-4739-a0a1-dcb66df44ab9
:BEAMER_env: frame
:END:

- [[file:data/75/971753-cddb-4739-a0a1-dcb66df44ab9/alert-status-speed-comparison.webm][Testing]] with 50,000 host data sets

** Global Host Search                                               :ATTACH:
:PROPERTIES:
:ID:       f97c9b4d-d46f-4aee-bd68-630f44106b0e
:Attachments: 2018-01-14_Selection_002_2018-01-14_13-21-21.png
:BEAMER_env: frame
:END:
- Easily find hosts by name, ip or identity

#+DOWNLOADED: /home/nickanderson/Pictures/Screenshots/2018-01-14_Selection_002.png @ 2018-01-14 13:21:24
[[file:data/f9/7c9b4d-d46f-4aee-bd68-630f44106b0e/2018-01-14_Selection_002_2018-01-14_13-21-21.png]]

** host count trend widget                                          :ATTACH:
:PROPERTIES:
:ID:       e90e4df9-0bb7-4a1e-84d5-25911497f93c
:Attachments: 2018-01-10_Selection_001_2018-01-14_12-02-44.png
:BEAMER_env: frame
:END:

#+DOWNLOADED: https://cfengine.com/wp-content/uploads/2018/01/2018-01-10_Selection_001.png @ 2018-01-14 12:02:44
[[file:data/e9/0e4df9-0bb7-4a1e-84d5-25911497f93c/2018-01-10_Selection_001_2018-01-14_12-02-44.png]]

** mail settings                                                    :ATTACH:
:PROPERTIES:
:ID:       748d9e15-278e-46ac-822f-9e0f7e6b2830
:Attachments: mail-settings-1024x537_2018-01-14_12-01-05.png
:BEAMER_env: frame
:END:

- Exported reports can now be sent as attachments in emails

#+DOWNLOADED: https://cfengine.com/wp-content/uploads/2018/01/mail-settings-1024x537.png @ 2018-01-14 12:01:05
[[file:data/74/8d9e15-278e-46ac-822f-9e0f7e6b2830/mail-settings-1024x537_2018-01-14_12-01-05.png]]

** LDAP settings API                                                :ATTACH:
:PROPERTIES:
:ID:       294c1258-49f4-4c72-9f8d-2b7535cfbea8
:Attachments: Authentication-settings_2018-01-14_12-04-18.png
:BEAMER_env: frame
:END:

#+DOWNLOADED: https://cfengine.com/wp-content/uploads/2018/01/Authentication-settings.png @ 2018-01-14 12:04:18
[[file:data/29/4c1258-49f4-4c72-9f8d-2b7535cfbea8/Authentication-settings_2018-01-14_12-04-18.png]]

** default roles                                                    :ATTACH:
:PROPERTIES:
:ID:       bf10ec4b-5b6b-4140-9336-fb7ab7808fed
:Attachments: 2018-01-14_Selection_004_2018-01-14_14-03-29.png
:BEAMER_env: frame
:END:

#+DOWNLOADED: /home/nickanderson/Pictures/Screenshots/2018-01-14_Selection_004.png @ 2018-01-14 14:03:32
[[file:data/bf/10ec4b-5b6b-4140-9336-fb7ab7808fed/2018-01-14_Selection_004_2018-01-14_14-03-29.png]]

** New OOTB Inventory Attributes
:PROPERTIES:
:BEAMER_env: frame
:END:

- Policy Release Id
- AIX OS Level
 
** Inventory API 
:PROPERTIES:
:BEAMER_env: frame
:END:

#+Caption: Example API Query
#+BEGIN_SRC shell
  curl --user admin -X POST \
    -H 'content-type: application/json' \
    https://hub/api/inventory -d '{ "select":[ "Host name", "OS type"]}'
#+END_SRC

** Inventory API
:PROPERTIES:
:BEAMER_env: frame
:END:

#+Caption: Example Query Response
#+BEGIN_SRC json
{
    "data": [
        {
            "header": [
                {
                    "columnName": "Host name",
                    "columnType": "STRING"
                },
                {
                    "columnName": "OS type",
                    "columnType": "STRING"
                }
            ],
            "queryTimeMs": 11,
            "rowCount": 2,
            "rows": [
                [
                    "host001",
                    "linux"
                ],
                [
                    "hub",
                    "linux"
                ]
            ]
        }
    ],
    "meta": {
        "count": 1,
        "page": 1,
        "timestamp": 1515607751,
        "total": 1
    }
}
#+END_SRC
